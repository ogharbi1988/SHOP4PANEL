
<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>SHOP 4 PANEL ‚Äî V4</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root{
  --bg-a:#05292d; --accent1:#00bfa6; --accent2:#10b981; --accent3:#ff8a00;
  --card-radius:16px; --shadow:0 20px 50px rgba(2,6,23,0.25);
  --muted:#7b8890;
}
*{box-sizing:border-box} html,body{height:100%;margin:0;font-family:Inter,system-ui, -apple-system, "Segoe UI", Roboto, Arial;}
body{background:linear-gradient(135deg,var(--bg-a),#0b3940 40%, #0f6e6a 70%, var(--accent3)); color:#03121a;}

/* layout & glass */
.container{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:28px;position:relative;z-index:2}
.card{width:100%;max-width:1200px;border-radius:22px;background:linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));box-shadow:var(--shadow);backdrop-filter:blur(10px);display:flex;overflow:hidden;border:1px solid rgba(255,255,255,0.06)}
.left{flex:1;padding:34px;color:white;background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);display:flex;flex-direction:column;justify-content:center}
.right{flex:1.05;padding:34px;background:transparent;display:flex;flex-direction:column;justify-content:center}

/* logo */
.logo{display:flex;align-items:center;gap:14px;margin-bottom:8px}
.logoBadge{width:72px;height:72px;border-radius:14px;display:flex;align-items:center;justify-content:center;background:linear-gradient(90deg,var(--accent1),var(--accent3));color:white;font-weight:900;font-size:22px}
.logoTitle{font-size:22px;font-weight:900}

/* form */
.form{width:100%;max-width:520px;margin:0 auto;display:flex;flex-direction:column;gap:12px}
.field{position:relative}
.field input[type="text"], .field input[type="email"], .field input[type="password"], .field input[type="number"], textarea, select{width:100%;padding:12px 12px 12px 48px;border-radius:12px;border:1px solid rgba(15,25,30,0.06);background:rgba(255,255,255,0.98);font-size:15px;outline:none}
.icon{position:absolute;left:12px;top:50%;transform:translateY(-50%);width:36px;height:36px;border-radius:8px;display:flex;align-items:center;justify-content:center;color:#fff;background:linear-gradient(90deg,var(--accent1),var(--accent2));box-shadow:0 6px 18px rgba(2,6,23,0.12)}
.field input:focus{box-shadow:0 10px 28px rgba(0,191,166,0.08)}

/* buttons */
.btn{padding:12px;border-radius:12px;border:none;background:linear-gradient(90deg,var(--accent1),var(--accent2));color:white;font-weight:800;cursor:pointer;box-shadow:0 12px 28px rgba(2,6,23,0.12)}
.smallBtn{padding:8px;border-radius:10px;border:1px solid rgba(2,6,23,0.06);background:transparent;cursor:pointer}

/* dashboard styles */
.app{display:none;min-height:100vh}
.topbar{display:flex;justify-content:space-between;align-items:center;padding:18px 28px;background:rgba(255,255,255,0.98);border-bottom:1px solid #eef3f4}
.wrapper{display:flex;min-height:calc(100vh - 74px)}

/* sidebar */
.sidebar{width:260px;background:linear-gradient(180deg,var(--accent1),#0f8);padding:18px;color:white}
.menu{margin-top:20px}
.menu .item{padding:10px 12px;border-radius:10px;cursor:pointer;display:flex;align-items:center;gap:10px}
.menu .item:hover{background:rgba(255,255,255,0.06)}

/* content */
.content{flex:1;padding:22px;background:#f7fbfc}

/* tiles */
.tiles{display:flex;gap:12px;flex-wrap:wrap}
.tile{background:white;padding:14px;border-radius:12px;box-shadow:0 8px 24px rgba(2,6,23,0.06);min-width:160px;flex:1}

/* product card */
.productCard{background:white;border-radius:12px;padding:12px;box-shadow:0 8px 18px rgba(2,6,23,0.04);display:flex;gap:10px;align-items:center}
.productCard img{width:84px;height:52px;object-fit:cover;border-radius:8px}

/* modal */
.modal{display:none;position:fixed;left:0;top:0;width:100%;height:100%;background:rgba(2,6,23,0.45);align-items:center;justify-content:center;z-index:9999}
.modal .modalInner{background:white;padding:18px;border-radius:12px;min-width:320px;max-width:720px;animation:modalIn .28s ease both}
@keyframes modalIn{from{opacity:0;transform:scale(.98)}to{opacity:1;transform:none}}

/* chart container */
.chartWrap{display:flex;gap:12px;align-items:center}

/* responsive */
@media (max-width:900px){ .card{flex-direction:column} .left,.right{padding:20px} .sidebar{display:none} .chartWrap{flex-direction:column} }

</style>
</head>
<body>
<div class="container" id="loginContainer">
  <div class="card">
    <div class="left">
      <div class="logo"><div class="logoBadge">S4</div><div><div class="logoTitle">SHOP 4 PANEL</div><div style="opacity:0.9">Vente IPTV Premium</div></div></div>
      <div style="margin-top:12px;font-weight:700;background:linear-gradient(90deg,var(--accent1),var(--accent3));-webkit-background-clip:text;color:transparent">Recharge et gagne plus avec les points de fid√©lit√©</div>
      <div style="margin-top:6px;font-weight:600;color:rgba(255,255,255,0.95);direction:rtl">ÿßÿ¥ÿ≠ŸÜ Ÿàÿßÿ±ÿ®ÿ≠ ÿ£ŸÉÿ´ÿ± ŸÖÿπ ŸÜŸÇÿßÿ∑ ÿßŸÑŸàŸÑÿßÿ°</div>
      <div style="margin-top:18px;color:rgba(255,255,255,0.9);font-size:13px">Support 24/7 ‚Ä¢ USDT (TRC20), Wafa Cash, Virement, Cash</div>
    </div>
    <div class="right">
      <form id="loginForm" class="form" autocomplete="on" novalidate>
        <div class="field"><div class="icon"><i class="fa fa-envelope"></i></div><input id="email" type="email" placeholder="Email"></div>
        <div class="field"><div class="icon"><i class="fa fa-lock"></i></div><input id="password" type="password" placeholder="Mot de passe"></div>
        <div style="display:flex;justify-content:space-between;align-items:center"><label><input id="remember" type="checkbox"> Se souvenir</label><div><a href="#" id="langFR">FR</a> ¬∑ <a href="#" id="langAR">AR</a></div></div>
        <div id="err" style="display:none;color:#b00020;font-weight:700"></div>
        <button type="submit" class="btn" id="btnLogin">Se connecter</button>
        <div style="display:flex;gap:8px;margin-top:12px">
          <button type="button" class="smallBtn" id="demoAdmin">Admin demo</button>
          <button type="button" class="smallBtn" id="demoUser">User demo</button>
        </div>
        <div style="margin-top:12px;font-size:13px;color:var(--muted)">
          <div><strong>Admin:</strong> ogharbi1988@shop4panel.com / admin1988</div>
          <div><strong>User:</strong> user@shop4panel.com / admin1988</div>
          <div><strong>Test:</strong> test@shop4panel.com / test123</div>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Dashboard (hidden until login) -->
<div class="app" id="app" style="display:none">
  <div class="topbar">
    <div><span style="font-weight:800;padding:10px 14px;border-radius:10px;background:linear-gradient(90deg,var(--accent1),var(--accent3));color:white">SHOP 4 PANEL</span></div>
    <div style="display:flex;align-items:center;gap:12px">
      <div id="langDisplay" style="font-weight:700"></div>
      <div id="userInfo" style="text-align:right">
        <div id="uName" style="font-weight:800">Invit√©</div>
        <div id="uRole" style="font-size:13px;color:var(--muted)">Non connect√©</div>
      </div>
      <div id="uAvatar" style="width:44px;height:44;background:linear-gradient(90deg,var(--accent1),var(--accent2));border-radius:10px;display:flex;align-items:center;justify-content:center;color:white;font-weight:800">S4</div>
    </div>
  </div>

  <div class="wrapper">
    <aside class="sidebar" id="sidebar">
      <div style="font-weight:800;padding:10px 14px;border-radius:10px;background:linear-gradient(90deg,var(--accent1),var(--accent3));color:white;display:inline-block">SHOP 4 PANEL</div>
      <div class="menu" style="margin-top:18px">
        <div class="item" data-page="dashboard-home"><i class="fa fa-home"></i> Tableau de bord</div>
        <div class="item" data-page="products"><i class="fa fa-box-open"></i> Produits</div>
        <div class="item" data-page="balance"><i class="fa fa-wallet"></i> Mon solde</div>
        <div class="item" data-page="history"><i class="fa fa-history"></i> Historique</div>
        <div class="item" data-page="tickets"><i class="fa fa-ticket-alt"></i> Tickets</div>
        <div class="item" data-page="generator"><i class="fa fa-key"></i> G√©n√©rateur</div>
        <div class="item" data-page="admin" id="adminMenu" style="display:none"><i class="fa fa-cogs"></i> Administration</div>
        <div class="item" data-page="settings"><i class="fa fa-cog"></i> Param√®tres</div>
        <div style="margin-top:16px"><button id="logoutBtn" class="btn" style="background:white;color:#05212a">D√©connexion</button></div>
      </div>
    </aside>

    <main class="content" id="content">
      <div style="padding:12px;border-radius:10px;background:linear-gradient(90deg,white,rgba(255,255,255,0.95));margin-bottom:12px">‚ö†Ô∏è Le montant minimum pour la recharge est de 500 DH ‚Äî ÿßŸÑÿ≠ÿØ ÿßŸÑÿ£ÿØŸÜŸâ ŸÑÿ•ÿπÿßÿØÿ© ÿßŸÑÿ¥ÿ≠ŸÜ ŸáŸà 500 ÿØÿ±ŸáŸÖ</div>

      <section id="dashboard-home" class="page">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <h3 style="margin:0">Tableau de bord</h3>
            <div style="color:var(--muted)">Aper√ßu</div>
          </div>
          <div id="adminTopProduct" style="font-weight:700;display:none">ü•á Top produit: ‚Äî</div>
        </div>

        <div style="display:flex;gap:12px;margin-top:12px;flex-wrap:wrap;align-items:flex-start">
          <div style="flex:1;min-width:320px">
            <div class="tiles">
              <div class="tile"><strong>Solde actuel</strong><div id="userBalance" style="font-weight:800;font-size:20px;margin-top:8px">0.00 MAD</div></div>
              <div class="tile"><strong>Produits disponibles</strong><div id="prodCount" style="font-weight:800;font-size:20px;margin-top:8px">0</div></div>
              <div class="tile"><strong>Tickets ouverts</strong><div style="font-weight:800;font-size:20px;margin-top:8px">0</div></div>
            </div>
          </div>

          <div style="width:420px">
            <div style="background:white;padding:12px;border-radius:12px;box-shadow:0 8px 24px rgba(2,6,23,0.06)">
              <div style="display:flex;justify-content:space-between;align-items:center">
                <div><strong>Produits les plus vendus</strong><div style="font-size:13px;color:var(--muted)">Distribution des ventes</div></div>
                <div id="legendSmall" style="font-size:13px;color:var(--muted)"></div>
              </div>
              <div class="chartWrap" style="margin-top:12px;align-items:center">
                <canvas id="salesPie" width="300" height="300" style="max-width:300px"></canvas>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section id="products" class="page" style="display:none;margin-top:12px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <h3>Produits</h3>
          <div id="prodCountTop">0</div>
        </div>
        <div id="productsContainer" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:12px;margin-top:12px"></div>
        <div style="margin-top:12px"><button id="openAddProduct" class="btn">Ajouter produit</button></div>
      </section>

      <section id="balance" class="page" style="display:none;margin-top:12px">
        <h3>Rechargement</h3>
        <div style="display:flex;gap:12px;flex-wrap:wrap;margin-top:12px">
          <div style="min-width:220px;flex:1">
            <div style="background:white;padding:12px;border-radius:12px;box-shadow:0 8px 24px rgba(2,6,23,0.06)">
              <div style="display:flex;align-items:center;gap:12px">
                <img src="https://cdn-icons-png.flaticon.com/512/8043/8043680.png" alt="usdt" width="42">
                <div><strong>USDT (TRC20)</strong><div style="font-size:13px;color:var(--muted)">Adresse TRC20 + QR</div></div>
                <div style="margin-left:auto"><button id="payUsdtBtn" class="btn">Payer</button></div>
              </div>
            </div>
          </div>

          <div style="min-width:220px;flex:1">
            <div style="background:white;padding:12px;border-radius:12px;box-shadow:0 8px 24px rgba(2,6,23,0.06)">
              <div style="display:flex;align-items:center;gap:12px">
                <img src="https://cdn-icons-png.flaticon.com/512/6404/6404655.png" alt="virement" width="42">
                <div><strong>Virement bancaire</strong><div style="font-size:13px;color:var(--muted)">IBAN et instructions</div></div>
                <div style="margin-left:auto"><button id="payWireBtn" class="btn">Payer</button></div>
              </div>
            </div>
          </div>

          <div style="min-width:220px;flex:1">
            <div style="background:white;padding:12px;border-radius:12px;box-shadow:0 8px 24px rgba(2,6,23,0.06)">
              <div style="display:flex;align-items:center;gap:12px">
                <img src="https://images.seeklogo.com/logo-png/25/1/wafacash-logo-png_seeklogo-251985.png" alt="wafacash" width="42">
                <div><strong>Wafa Cash</strong><div style="font-size:13px;color:var(--muted)">Nom + r√©f√©rence</div></div>
                <div style="margin-left:auto"><button id="payWafaBtn" class="btn">Payer</button></div>
              </div>
            </div>
          </div>

          <div style="min-width:220px;flex:1">
            <div style="background:white;padding:12px;border-radius:12px;box-shadow:0 8px 24px rgba(2,6,23,0.06)">
              <div style="display:flex;align-items:center;gap:12px">
                <img src="https://cdn-icons-png.flaticon.com/512/3081/3081015.png" alt="cash" width="42">
                <div><strong>Cash</strong><div style="font-size:13px;color:var(--muted)">Remise en main propre</div></div>
                <div style="margin-left:auto"><button id="payCashBtn" class="btn">Payer</button></div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section id="history" class="page" style="display:none;margin-top:12px">
        <h3>Historique</h3>
        <div id="historyList" class="table" style="margin-top:12px"></div>
      </section>

      <section id="tickets" class="page" style="display:none;margin-top:12px">
        <h3>Tickets</h3>
        <div style="margin-top:12px"><button id="newTicketBtn" class="btn">Nouveau ticket</button></div>
      </section>

      <section id="generator" class="page" style="display:none;margin-top:12px">
        <h3>G√©n√©rateur</h3>
        <form id="genForm" style="display:flex;gap:8px;align-items:center;margin-top:12px">
          <select id="genProduct" style="padding:8px;border-radius:8px"><option value="">Choisir produit</option></select>
          <input id="genQty" type="number" min="1" value="1" style="padding:8px;border-radius:8px;width:80px">
          <button class="btn">G√©n√©rer</button>
        </form>
        <div id="generated" style="margin-top:12px"></div>
      </section>

      <section id="admin" class="page" style="display:none;margin-top:12px">
        <h3>Administration</h3>
        <div class="table" style="margin-top:12px">
          <table style="width:100%;border-collapse:collapse"><thead><tr style="text-align:left"><th>Nom</th><th>Email</th><th>R√¥le</th><th>Derni√®re connexion</th><th>Dur√©e</th><th>Statut</th><th>Solde</th><th>Ventes</th></tr></thead><tbody id="adminUsersTable"></tbody></table>
        </div>
        <div style="margin-top:12px"><button id="openAddUser" class="btn">Ajouter utilisateur</button></div>
      </section>

      <section id="settings" class="page" style="display:none;margin-top:12px">
        <h3>Param√®tres</h3>
        <div style="margin-top:12px">Langue : <select id="langSelect"><option value="fr">Fran√ßais</option><option value="ar">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option></select></div>
      </section>

    </main>
  </div>
</div>

<!-- Modals -->
<div class="modal" id="modalAddUser"><div class="modalInner">
  <h4>Ajouter un utilisateur</h4>
  <div style="margin-top:8px"><input id="newName" placeholder="Nom complet"></div>
  <div style="margin-top:8px"><input id="newEmail" placeholder="Email"></div>
  <div style="margin-top:8px"><input id="newPassword" placeholder="Mot de passe"></div>
  <div style="margin-top:8px"><select id="newRole"><option value="user">Utilisateur</option><option value="test">Test (12h)</option><option value="admin">Administrateur</option></select></div>
  <div style="margin-top:8px"><input id="newBalance" type="number" placeholder="Solde initial (MAD)" value="0"></div>
  <div style="margin-top:12px;display:flex;justify-content:flex-end;gap:8px"><button id="cancelAddUser" class="smallBtn">Annuler</button><button id="confirmAddUser" class="btn">Cr√©er</button></div>
</div></div>

<div class="modal" id="modalAddProduct"><div class="modalInner">
  <h4>Ajouter un produit</h4>
  <div style="margin-top:8px"><input id="pName" placeholder="Nom du produit"></div>
  <div style="margin-top:8px"><input id="pPrice" type="number" placeholder="Prix (MAD)"></div>
  <div style="margin-top:8px"><input id="pCategory" placeholder="Cat√©gorie"></div>
  <div style="margin-top:8px"><input id="pStock" type="number" placeholder="Stock" value="10"></div>
  <div style="margin-top:8px"><label>Image (URL ou fichier)</label><input id="pImageUrl" placeholder="https://..."><input id="pImageFile" type="file" accept="image/*"></div>
  <div style="margin-top:8px"><img id="pPreview" src="" alt="Aper√ßu" style="width:160px;height:90px;object-fit:cover;border-radius:8px;display:none"></div>
  <div style="margin-top:12px;display:flex;justify-content:flex-end;gap:8px"><button id="cancelAddProduct" class="smallBtn">Annuler</button><button id="confirmAddProduct" class="btn">Cr√©er</button></div>
</div></div>

<div class="modal" id="modalPay"><div class="modalInner">
  <h4 id="modalPayTitle">Paiement</h4>
  <div id="modalPayBody" style="margin-top:8px"></div>
  <div style="margin-top:12px;display:flex;justify-content:flex-end;gap:8px"><button id="cancelPay" class="smallBtn">Annuler</button><button id="confirmPay" class="btn">Confirmer paiement</button></div>
</div></div>

<script>
/* ---------- Data and storage ---------- */
const defaultProducts = [
  {id:1,name:"LPTV M3U 12 Mois",category:"M3U",price:350,stock:10,image:""},
  {id:2,name:"CODE HTV 6 Mois",category:"CODE",price:250,stock:12,image:""},
  {id:3,name:"LPTV Test 24h",category:"TEST",price:0,stock:50,image:""}
];
const defaultUsers = [
  {id:1,name:"Admin Ogharbi",email:"ogharbi1988@shop4panel.com",password:"admin1988",role:"admin",balance:1500,sales:45,lastLogin:null,sessionStart:null,isOnline:false},
  {id:2,name:"User Demo",email:"user@shop4panel.com",password:"admin1988",role:"user",balance:500,sales:8,lastLogin:null,sessionStart:null,isOnline:false},
  {id:3,name:"Test User",email:"test@shop4panel.com",password:"test123",role:"test",balance:0,sales:2,lastLogin:null,sessionStart:null,isOnline:false}
];

function save(key,val){ try{ localStorage.setItem('s4p_'+key,JSON.stringify(val)); }catch(e){console.warn(e);} }
function load(key){ try{ const v=localStorage.getItem('s4p_'+key); return v?JSON.parse(v):null;}catch(e){return null;} }

if(!load('products')) save('products', defaultProducts);
if(!load('users')) save('users', defaultUsers);

/* ---------- Helpers ---------- */
const el = id => document.getElementById(id);
function openModal(id){ el(id).style.display='flex'; }
function closeModal(id){ el(id).style.display='none'; }

/* ---------- Language ---------- */
function applyLanguage(lang){
  sessionStorage.setItem('s4p_lang', lang);
  if(lang==='ar'){ document.body.classList.add('rtl'); el('langDisplay').textContent='ÿßŸÑÿπÿ±ÿ®Ÿäÿ©'; el('sidebar').classList.add('rtl'); el('langSelect').value='ar'; }
  else { document.body.classList.remove('rtl'); el('langDisplay').textContent='Fran√ßais'; el('sidebar').classList.remove('rtl'); el('langSelect').value='fr'; }
}
el('langFR').addEventListener('click',(e)=>{e.preventDefault();applyLanguage('fr');});
el('langAR').addEventListener('click',(e)=>{e.preventDefault();applyLanguage('ar');});
el('langSelect').addEventListener('change',()=>applyLanguage(el('langSelect').value));
applyLanguage(sessionStorage.getItem('s4p_lang')||'fr');

/* ---------- Login same-tab ---------- */
const users = load('users') || defaultUsers;
el('demoAdmin').addEventListener('click', ()=>{ el('email').value='ogharbi1988@shop4panel.com'; el('password').value='admin1988'; el('remember').checked=true; });
el('demoUser').addEventListener('click', ()=>{ el('email').value='user@shop4panel.com'; el('password').value='admin1988'; el('remember').checked=true; });

el('loginForm').addEventListener('submit', function(e){
  e.preventDefault();
  el('err').style.display='none';
  const email = el('email').value.trim(), password = el('password').value.trim();
  if(!email||!password){ el('err').textContent='Veuillez remplir tous les champs'; el('err').style.display='block'; return; }
  el('btnLogin').disabled = true;
  setTimeout(()=>{
    el('btnLogin').disabled = false;
    const u = users.find(x=>x.email===email && x.password===password);
    if(!u){ el('err').textContent='Email ou mot de passe incorrect'; el('err').style.display='block'; return; }
    if(el('remember').checked) save('s4p_user', u); else localStorage.removeItem('s4p_user');
    save('session', u);
    document.querySelector('.container').style.display='none';
    document.getElementById('app').style.display='block';
    initDashboard();
  },900);
});

/* ---------- Dashboard init ---------- */
function initDashboard(){
  const session = load('session') || load('s4p_user');
  if(!session) return;
  el('uName').textContent = session.name;
  el('uRole').textContent = session.role==='admin'?'Administrateur':(session.role==='test'?'Utilisateur test':'Utilisateur');
  el('uAvatar').textContent = session.name.split(' ').map(n=>n[0]).join('').slice(0,2).toUpperCase();
  el('userBalance').textContent = (session.balance||0).toFixed(2)+' MAD';
  if(session.role==='admin') el('adminMenu').style.display='block'; else el('adminMenu').style.display='none';
  renderProducts(); renderUsersTable(); renderHistory(); updateSalesChart(); showPage('dashboard-home');
}

/* ---------- Navigation ---------- */
const pages = ['dashboard-home','products','balance','history','tickets','generator','admin','settings'];
function showPage(id){ pages.forEach(p=> document.getElementById(p).style.display = (p===id?'block':'none')); }
document.querySelectorAll('.menu .item').forEach(it=> it.addEventListener('click', ()=>{
  const page = it.dataset.page; const s = load('session') || load('s4p_user');
  if(page==='admin' && (!s || s.role!=='admin')){ alert('Acc√®s r√©serv√© aux administrateurs'); return; }
  showPage(page);
}));
el('logoutBtn').addEventListener('click', ()=>{ localStorage.removeItem('s4p_user'); localStorage.removeItem('session'); location.reload(); });

/* ---------- Products ---------- */
function renderProducts(){
  const products = load('products')||[]; const container = el('productsContainer'); container.innerHTML='';
  products.forEach(p=>{
    const div = document.createElement('div'); div.className='productCard';
    const img = p.image ? `<img src="${p.image}" alt="${p.name}">` : `<img src="https://via.placeholder.com/300x150/10b981/ffffff?text=Produit" alt="placeholder">`;
    div.innerHTML = `${img}<div style="flex:1"><div style="font-weight:800">${p.name}</div><div style="color:var(--muted)">${p.category} ‚Ä¢ ${p.stock} en stock</div><div style="margin-top:6px;font-weight:700">${p.price>0?p.price.toFixed(2)+' MAD':'GRATUIT'}</div><div style="margin-top:8px"><button class="btn buyBtn" data-id="${p.id}">Acheter</button></div></div>`;
    container.appendChild(div);
  });
  el('prodCount').textContent = products.length; el('prodCountTop').textContent = products.length;
  // fill generator select
  const sel = el('genProduct'); sel.innerHTML = '<option value="">Choisir produit</option>';
  products.forEach(p=> sel.insertAdjacentHTML('beforeend', `<option value="${p.id}">${p.name}</option>`));
  updateSalesChart();
}

/* ---------- Add product modal (image handling) ---------- */
el('openAddProduct').addEventListener('click', ()=>{ el('pName').value=''; el('pPrice').value=''; el('pCategory').value=''; el('pStock').value='10'; el('pImageUrl').value=''; el('pImageFile').value=''; el('pPreview').style.display='none'; openModal('modalAddProduct'); });
el('cancelAddProduct').addEventListener('click', ()=> closeModal('modalAddProduct'));

el('pImageFile').addEventListener('change', function(e){
  const file = e.target.files[0]; if(!file) return;
  const reader = new FileReader(); reader.onload = function(ev){ el('pPreview').src = ev.target.result; el('pPreview').style.display='block'; el('pImageUrl').value = ev.target.result; }; reader.readAsDataURL(file);
});

el('confirmAddProduct').addEventListener('click', ()=>{
  const name = el('pName').value.trim(); const price = parseFloat(el('pPrice').value)||0; const cat = el('pCategory').value.trim(); const stock = parseInt(el('pStock').value)||0; const img = el('pImageUrl').value.trim();
  if(!name){ alert('Nom requis'); return; }
  const products = load('products')||[]; const id = (products.reduce((m,x)=>Math.max(m,x.id),0)||0)+1;
  products.push({id,name,category:cat,price,stock,image:img}); save('products', products); renderProducts(); closeModal('modalAddProduct'); alert('Produit ajout√©');
});

/* ---------- Users table ---------- */
function renderUsersTable(){
  const users = load('users')||[]; const tbody = el('adminUsersTable'); tbody.innerHTML='';
  users.forEach(u=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${u.name}</td><td>${u.email}</td><td>${u.role}</td><td>${u.lastLogin?new Date(u.lastLogin).toLocaleString():'Jamais'}</td><td>-</td><td>${u.isOnline?'<span style="color:green">En ligne</span>':'<span style="color:#94a3b8">Hors ligne</span>'}</td><td>${(u.balance||0).toFixed(2)} MAD</td><td>${u.sales||0}</td>`;
    tbody.appendChild(tr);
  });
}

/* ---------- History ---------- */
function renderHistory(){ const h = load('history')||[]; const elh = el('historyList'); elh.innerHTML=''; h.forEach(it=> elh.insertAdjacentHTML('beforeend', `<div style="padding:8px;border-bottom:1px solid #f3f4f6">${it}</div>`)); }
function addHistory(item){ const h = load('history')||[]; h.unshift(item); save('history', h); renderHistory(); }

/* ---------- Purchase handling & sales tracking ---------- */
document.body.addEventListener('click', function(e){
  if(e.target.classList.contains('buyBtn')){
    const pid = parseInt(e.target.dataset.id); const products = load('products')||[]; const p = products.find(x=>x.id===pid);
    const u = load('session') || load('s4p_user'); if(!u){ alert('Connectez-vous'); return; }
    if(u.balance < p.price){ alert('Solde insuffisant'); return; }
    // debit and update user & sales
    u.balance = (u.balance||0) - p.price;
    const users = load('users')||[]; const idx = users.findIndex(x=>x.email===u.email);
    if(idx!==-1){ users[idx].balance = u.balance; users[idx].sales = (users[idx].sales||0) + 1; save('users', users); save('s4p_user', users[idx]); save('session', users[idx]); }
    // increment product sale count stored in products as sales property
    const prodIdx = products.findIndex(x=>x.id===pid); products[prodIdx].sales = (products[prodIdx].sales||0) + 1; save('products', products);
    el('userBalance').textContent = u.balance.toFixed(2)+' MAD';
    addHistory(`Achat: ${p.name} - ${p.price} MAD`);
    alert('Achat effectu√© : ' + p.name);
    renderProducts(); renderUsersTable(); updateSalesChart();
  }
});

/* ---------- Payments modals (USDT, Wire, Wafa, Cash) ---------- */
const usdtAddr = 'TJ6Xw1hTE3aEaDhqGjS5xpg3M4svRihiA5';
function openPayModal(title, htmlContent, onConfirm){
  el('modalPayTitle').textContent = title; el('modalPayBody').innerHTML = htmlContent; openModal('modalPay');
  el('confirmPay').onclick = function(){ try{ onConfirm(); } catch(e){console.warn(e);} closeModal('modalPay'); };
  el('cancelPay').onclick = function(){ closeModal('modalPay'); };
}

el('payUsdtBtn').addEventListener('click', ()=>{
  const qr = 'https://chart.googleapis.com/chart?cht=qr&chs=300x300&chl=' + encodeURIComponent(usdtAddr);
  const html = `<div style="display:flex;gap:12px;align-items:center"><div style="width:160px;height:160px"><img src="${qr}" style="width:100%;height:100%;object-fit:contain;border-radius:8px"></div><div><div style="font-weight:700">Adresse TRC20</div><div style="font-family:monospace;margin-top:8px">${usdtAddr}</div></div></div>`;
  openPayModal('Payer en USDT (TRC20)', html, ()=>{
    const amt = parseFloat(prompt('Montant (MAD) re√ßu (min 500):','500'))||0; if(amt<500){ alert('Montant invalide (min 500)'); return; }
    const u = load('session') || load('s4p_user'); if(!u){ alert('Utilisateur introuvable'); return; }
    const users = load('users')||[]; const idx = users.findIndex(x=>x.email===u.email); if(idx!==-1){ users[idx].balance = (users[idx].balance||0) + amt; save('users', users); save('s4p_user', users[idx]); save('session', users[idx]); el('userBalance').textContent = users[idx].balance.toFixed(2)+' MAD'; addHistory(`Recharge USDT: ${amt} MAD`); alert('Recharge confirm√©e'); }
  });
});

el('payWireBtn').addEventListener('click', ()=>{
  const html = `<div><div><strong>Virement bancaire</strong></div><div style="margin-top:8px">IBAN: <span style="font-family:monospace">MA00 0000 0000 0000</span></div><div style="margin-top:8px">Nom: SHOP 4 PANEL</div></div>`;
  openPayModal('Virement bancaire', html, ()=>{
    const amt = parseFloat(prompt('Montant (MAD) re√ßu (min 500):','500'))||0; if(amt<500){ alert('Montant invalide (min 500)'); return; }
    const u = load('session') || load('s4p_user'); if(!u){ alert('Utilisateur introuvable'); return; }
    const users = load('users')||[]; const idx = users.findIndex(x=>x.email===u.email); if(idx!==-1){ users[idx].balance = (users[idx].balance||0) + amt; save('users', users); save('s4p_user', users[idx]); save('session', users[idx]); el('userBalance').textContent = users[idx].balance.toFixed(2)+' MAD'; addHistory(`Recharge Virement: ${amt} MAD`); alert('Recharge confirm√©e'); }
  });
});

el('payWafaBtn').addEventListener('click', ()=>{
  const ref = 'WF-'+Math.random().toString(36).slice(2,8).toUpperCase();
  const html = `<div><div><strong>Wafa Cash</strong></div><div style="margin-top:8px">R√©f√©rence: <span style="font-family:monospace">${ref}</span></div><div style="margin-top:8px">Nom: SHOP 4 PANEL</div></div>`;
  openPayModal('Wafa Cash', html, ()=>{
    const amt = parseFloat(prompt('Montant (MAD) re√ßu (min 500):','500'))||0; if(amt<500){ alert('Montant invalide (min 500)'); return; }
    const u = load('session') || load('s4p_user'); if(!u){ alert('Utilisateur introuvable'); return; }
    const users = load('users')||[]; const idx = users.findIndex(x=>x.email===u.email); if(idx!==-1){ users[idx].balance = (users[idx].balance||0) + amt; save('users', users); save('s4p_user', users[idx]); save('session', users[idx]); el('userBalance').textContent = users[idx].balance.toFixed(2)+' MAD'; addHistory(`Recharge Wafa: ${amt} MAD`); alert('Recharge confirm√©e'); }
  });
});

el('payCashBtn').addEventListener('click', ()=>{
  const html = `<div><div><strong>Cash</strong></div><div style="margin-top:8px">Remise en main propre - Confirmer la r√©ception</div></div>`;
  openPayModal('Paiement Cash', html, ()=>{
    const amt = parseFloat(prompt('Montant (MAD) re√ßu (min 500):','500'))||0; if(amt<500){ alert('Montant invalide (min 500)'); return; }
    const u = load('session') || load('s4p_user'); if(!u){ alert('Utilisateur introuvable'); return; }
    const users = load('users')||[]; const idx = users.findIndex(x=>x.email===u.email); if(idx!==-1){ users[idx].balance = (users[idx].balance||0) + amt; save('users', users); save('s4p_user', users[idx]); save('session', users[idx]); el('userBalance').textContent = users[idx].balance.toFixed(2)+' MAD'; addHistory(`Recharge Cash: ${amt} MAD`); alert('Recharge confirm√©e'); }
  });
});

/* ---------- Generator ---------- */
el('genForm').addEventListener('submit', (e)=>{
  e.preventDefault();
  const session = load('session') || load('s4p_user'); if(!session || session.role!=='admin'){ alert('Acc√®s r√©serv√© aux administrateurs'); return; }
  const pid = el('genProduct').value; const qty = parseInt(el('genQty').value)||1; if(!pid){ alert('Choisir un produit'); return; }
  let codes=''; for(let i=0;i<qty;i++) codes += 'CODE-'+Math.random().toString(36).slice(2,10).toUpperCase()+'<br>';
  el('generated').innerHTML = `<div class="table" style="padding:12px"><strong>Codes g√©n√©r√©s:</strong><div style="margin-top:8px;font-family:monospace">${codes}</div></div>`;
});

/* ---------- Chart.js: Sales pie (user / global) ---------- */
let salesPieChart = null;
function updateSalesChart(){
  const products = load('products')||[];
  // aggregate sales per product
  const labels = products.map(p=>p.name);
  const data = products.map(p=>p.sales||0);
  const colors = products.map((_,i)=>['#0bb7a0','#10b981','#ff8a00','#6366f1'][i%4]);
  const ctx = document.getElementById('salesPie').getContext('2d');
  if(salesPieChart) salesPieChart.destroy();
  salesPieChart = new Chart(ctx, {
    type: 'pie',
    data: { labels, datasets:[{data, backgroundColor: colors}] },
    options: { responsive:true, animation:{animateScale:true, duration:1000} }
  });
  // legend
  const legend = document.getElementById('legendSmall'); legend.innerHTML = products.map((p,i)=>`<div style="display:flex;align-items:center;gap:6px"><span style="width:12px;height:12px;background:${colors[i]};display:inline-block;border-radius:3px"></span> ${p.name} (${p.sales||0})</div>`).join('');
  // admin top product
  const session = load('session') || load('s4p_user');
  if(session && session.role==='admin'){ const top = products.slice().sort((a,b)=>(b.sales||0)-(a.sales||0))[0]; if(top) el('adminTopProduct').textContent = `ü•á Top produit : ${top.name} ‚Äì ${top.sales||0} ventes`; el('adminTopProduct').style.display='block'; }
}

/* ---------- Users table refresh on init ---------- */
function renderUsersTable(){ const users = load('users')||[]; const tbody = el('adminUsersTable'); tbody.innerHTML=''; users.forEach(u=>{ const tr = document.createElement('tr'); tr.innerHTML = `<td>${u.name}</td><td>${u.email}</td><td>${u.role}</td><td>${u.lastLogin?new Date(u.lastLogin).toLocaleString():'Jamais'}</td><td>-</td><td>${u.isOnline?'<span style="color:green">En ligne</span>':'<span style="color:#94a3b8">Hors ligne</span>'}</td><td>${(u.balance||0).toFixed(2)} MAD</td><td>${u.sales||0}</td>`; tbody.appendChild(tr); }); updateSalesChart(); }

/* ---------- Add user modal ---------- */
el('openAddUser').addEventListener('click', ()=>{ el('newName').value=''; el('newEmail').value=''; el('newPassword').value=''; el('newBalance').value='0'; openModal('modalAddUser'); });
el('cancelAddUser').addEventListener('click', ()=> closeModal('modalAddUser'));
el('confirmAddUser').addEventListener('click', ()=>{
  const name = el('newName').value.trim(), email = el('newEmail').value.trim(), password = el('newPassword').value.trim();
  const role = el('newRole').value, bal = parseFloat(el('newBalance').value)||0;
  if(!name||!email||!password){ alert('Tous les champs sont requis'); return; }
  const users = load('users')||[]; if(users.find(u=>u.email===email)){ alert('Email d√©j√† utilis√©'); return; }
  const id = (users.reduce((m,x)=>Math.max(m,x.id),0)||0)+1;
  users.push({id,name,email,password,role,balance:bal,sales:0,lastLogin:null,sessionStart:null,isOnline:false}); save('users', users); renderUsersTable(); closeModal('modalAddUser'); alert('Utilisateur ajout√©');
});

/* ---------- Initial setup if session exists ---------- */
(function init(){
  if(!load('products')) save('products', defaultProducts);
  if(!load('users')) save('users', defaultUsers);
  const session = load('session') || load('s4p_user');
  if(session){ document.querySelector('.container').style.display='none'; document.getElementById('app').style.display='block'; initDashboard(); }
})();

</script>
</body>
</html>
